<!DOCTYPE html>
<html>

<head>
  <title>Monopoly Chess</title>
  <link rel="stylesheet" href="chessboard/css/chessboard-1.0.0.css">
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="chessboard/js/chessboard-1.0.0.js"></script>
  <script src="chess/chess.js"></script>

</head>

<body style="background-color:rgb(50, 211, 157)">

  <div id="purchaseMenu" style="position: fixed;  left: 900px;
  top: 50px;">
    <input id='Property' maxlength="2" size="2"></input>
    <button id='Buy'>Buy</button>
    <label style="font-family:verdana"> Cost </label>
    <div id="costFactor"></div>
  </div>

  <div id="tradeMenu" style="position: fixed;  left: 900px;
  top: 300px;">
    <input id='PropertyTrade' maxlength="10" size="10"></input>
    <div>
      <button id='Offer'>Offer</button>
      <div id="offerList">
        No offers
      </div>
      <button id='Recieve'>Recieve</button>
      <div id="recieveList">
        Nothing recieved
      </div>
      <button id='Propose'>Propose Trade</button>
    </div>
  </div>

  <div id="myBoard" style="width: 800px"></div>
  <label style="font-family:verdana; text-align:center">Status:</label>
  <div id="status"></div>

  <label style="font-family:verdana; text-align:center">White Money:</label>
  <div id="whitemoney"></div>

  <label style="font-family:verdana; text-align:center">Black Money:</label>
  <div id="blackmoney"></div>

  </div>
  <label style="font-family:verdana; text-align:center">PGN:</label>
  <div id="pgn"></div>

  <div style="text-align: right;">
    <script>

      const SQUARES = {
        a8: 0, b8: 1, c8: 2, d8: 3, e8: 4, f8: 5, g8: 6, h8: 7,
        a7: 16, b7: 17, c7: 18, d7: 19, e7: 20, f7: 21, g7: 22, h7: 23,
        a6: 32, b6: 33, c6: 34, d6: 35, e6: 36, f6: 37, g6: 38, h6: 39,
        a5: 48, b5: 49, c5: 50, d5: 51, e5: 52, f5: 53, g5: 54, h5: 55,
        a4: 64, b4: 65, c4: 66, d4: 67, e4: 68, f4: 69, g4: 70, h4: 71,
        a3: 80, b3: 81, c3: 82, d3: 83, e3: 84, f3: 85, g3: 86, h3: 87,
        a2: 96, b2: 97, c2: 98, d2: 99, e2: 100, f2: 101, g2: 102, h2: 103,
        a1: 112, b1: 113, c1: 114, d1: 115, e1: 116, f1: 117, g1: 118, h1: 119
      };

      var board = null
      var game = new Chess()
      var $status = $('#status')
      var $pgn = $('#pgn')
      var $whitemoney = $('#whitemoney')
      var $blackmoney = $('#blackmoney')
      var notation = [];
      var property = new Array(128);
      property.fill(0)
      var money = [500, 500]
      var rentFactor = 50;
      var payFactor = 50
      var costFactor = 100
      var $costFact = $('#costFactor')
      $costFact = costFactor

      //var boardRows= document.getElementById('myBoard')
      //console.log(boardRows)
      var offers = [];
      var recieves = [];
      $('#Buy').on('click', function purchase() {
        var square = SQUARES[$('#Property').val()];
        if (square != undefined) {
          if (Math.abs(property[square]) < 5) {
            if (game.turn() === 'w') {
              if (money[0] >= costFactor) {
                //var boardSquare = boardRows.item(Math.floor(square/16)).item(square%16)
                property[square] += 1
                money[0] -= costFactor
                document.getElementById('propertyVal' + square).className = "notation-322f9 numeric-red"
                document.getElementById('propertyVal' + square).innerHTML = Math.abs(property[square])
              }
            }
            else {
              if (money[1] >= costFactor) {
                //var boardSquare = boardRows.item(Math.floor(square/16)).item(square%16)
                property[square] -= 1
                money[1] -= costFactor
                document.getElementById('propertyVal' + square).className = "notation-322f9 numeric-blue"
                document.getElementById('propertyVal' + square).innerHTML = Math.abs(property[square])
              }
            }
          }
        }
      })

      $('#Offer').on('click', function purchase() {
        if ($('#PropertyTrade').val()[0] == "$") {
          offers.push($('#PropertyTrade').val())
        }
        if (SQUARES[$('#PropertyTrade').val()] != undefined) {
          offers.push($('#PropertyTrade').val())
        }
        updateTradeList();
      })

      $('#Recieve').on('click', function purchase() {
        if ($('#PropertyTrade').val()[0] == "$") {
          recieves.push($('#PropertyTrade').val())
        }
        if (SQUARES[$('#PropertyTrade').val()] != undefined) {
          recieves.push($('#PropertyTrade').val())
        }
        updateTradeList();
      })


      var updateTradeList = function () {
        document.getElementById('offerList').innerHTML = "";
        if (offers.length == 0) {
          document.getElementById('offerList').innerHTML = "No offers";
        }
        else {
          var i = 0;
          offers.forEach(function (gameId) {
            $('#offerList').append($('<button>').text(gameId).val(i).on('click', function () {
              offers.splice(this.value, 1);
              updateTradeList();
            }));
            i++
          });
        }

        document.getElementById('recieveList').innerHTML = "";
        if (recieves.length == 0) {
          document.getElementById('recieveList').innerHTML = "Nothing recieved";
        }
        else {
          var i = 0;
          recieves.forEach(function (gameId) {
            $('#recieveList').append($('<button>').text(gameId).val(i).on('click', function () {
              recieves.splice(this.value, 1);
              updateTradeList();
            }));
            i++
          });
        }
      };



      function onDragStart(source, piece, position, orientation) {

        // do not pick up pieces if the game is over
        if (game.game_over() || money[0] < 0 || money[1] < 0) return false

        // only pick up pieces for the side to move
        if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
          (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
          return false
        }
      }

      function onDrop(source, target) {
        // see if the move is legal
        var move = game.move({
          from: source,
          to: target,
          promotion: 'q' // NOTE: always promote to a queen for example simplicity
        })
        if (move === null) { return 'snapback' }
        else {
          if (game.turn() === 'w') {
            if (property[SQUARES[target]] > 0) {
              rent = property[SQUARES[target]] * rentFactor
              money[1] -= rent
              money[0] += rent
            }
            money[1] += payFactor
          }
          else {
            if (property[SQUARES[target]] < 0) {
              rent = property[SQUARES[target]] * rentFactor
              money[1] -= rent
              money[0] += rent
            }
            money[0] += payFactor
          }
        }

        updateStatus(source, target)

      }

      // update the board position after the piece snap
      // for castling, en passant, pawn promotion
      function onSnapEnd() {
        board.position(game.fen())
      }

      function updateStatus(source, target) {
        $whitemoney.html("$" + money[0])
        $blackmoney.html("$" + money[1])

        var pieceType = game.get(target).type.toUpperCase()
        var entry = source + target
        if (game.turn() == 'b') {
          if (pieceType == "P") {
            notation.push((notation.length + 1) + ". " + entry + " ")
          }
          else {
            notation.push((notation.length + 1) + ". " + pieceType + entry + " ")
          }
        }
        else {
          if (pieceType == "P") {
            notation[notation.length - 1] = notation[notation.length - 1] + entry + "<br/>"
          }
          else {
            notation[notation.length - 1] = notation[notation.length - 1] + pieceType + entry + "<br/>"
          }
        }


        var status = ''
        console.log(game.turn())
        var moveColor = 'White'
        if (game.turn() == 'b') {
          moveColor = 'Black'
        }

        console.log(game.game_over())
        // checkmate?
        if (game.game_over()) {
          status = 'Game over, ' + moveColor + ' is checkmated.'
        }
        else if (money[0] < 0) {
          status = "White went bankrupt"
        }
        else if (money[1] < 0) {
          status = "Black went bankrupt"
        }
        else {
          status = moveColor + ' to move'
        }

        $status.html(status)
        $pgn.html(notation)
      }

      var config = {
        draggable: true,
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd
      };
      board = Chessboard('myBoard', config)

      updateStatus()
    </script>
  </div>
</body>

</html>